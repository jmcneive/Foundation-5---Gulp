define(["jquery","libs/jquery.history.min"],function(t){return init=function(){log("FUNCTION: Ajaxify");var e=".ajaxify",i=t(e).filter(":first"),n=i.get(0),a=(t("nav.main ul").filter(":first"),"statechangecomplete"),r=t(window),o=t(document.body),c=History.getRootUrl();0===i.length&&(i=o),t.expr[":"].internal=function(e){var i,n=t(e),a=n.attr("href")||"";return i=a.substring(0,c.length)===c||-1===a.indexOf(":")};var l=function(t){var e=String(t).replace(/<\!DOCTYPE[^>]*>/i,"").replace(/<(html|head|body|title|meta|script)([\s\>])/gi,'<div class="document-$1"$2').replace(/<\/(html|head|body|title|meta|script)\>/gi,"</div>");return e};t.fn.ajaxify=function(){var e=t(this);return e.find("a:internal:not(.no-ajaxy)").click(function(e){var i=t(this),n=i.attr("href"),a=i.attr("title")||null;return 2==e.which||e.metaKey?!0:(History.pushState(null,a,n),e.preventDefault(),!1)}),e},i.ajaxify(),r.bind("statechange",function(){{var t=History.getState(),e=t.url,i=e.replace(c,"");i.split("/")}transition_out()}),transition_out=function(){o.addClass("transition out"),i.animate({opacity:0},500,function(){o.removeClass("out"),loadit()})},transition_in=function(){UTIL.init(),o.addClass("in"),i.animate({opacity:1},500,function(){o.removeClass("transition in")})},loadit=function(){var s=History.getState(),d=s.url,u=d.replace(c,"");o.addClass("loading"),t.ajax({url:d,success:function(c){var s,f,m=t(l(c)),h=m.find(".document-body:first"),p=h.find(e).filter(":first");if(f=p.find(".document-script"),f.length&&f.detach(),s=p.html()||m.html(),!s)return document.location.href=d,!1;i.stop(!0,!0),i.html(s).ajaxify(),transition_in(),document.title=m.find(".document-title:first").text();try{document.getElementsByTagName("title")[0].innerHTML=document.title.replace("<","&lt;").replace(">","&gt;").replace(" & "," &amp; ")}catch(y){}f.each(function(){var e=t(this),i=e.text(),a=document.createElement("script");a.appendChild(document.createTextNode(i)),n.appendChild(a)});var g=m.find(".document-body:first").prop("attributes"),v=m.find(".document-body:first").attr("class");t.each(g,function(){"class"!=this.name&&o.attr(this.name,this.value)}),o.attr("class",v),t("html, body").animate({scrollTop:0},400),o.removeClass("loading"),r.trigger(a),"undefined"!=typeof window._gaq&&window._gaq.push(["_trackPageview",u]),"undefined"!=typeof window.reinvigorate&&"undefined"!=typeof window.reinvigorate.ajax_track&&reinvigorate.ajax_track(d)},error:function(){return document.location.href=d,!1}})}},{init:init}});