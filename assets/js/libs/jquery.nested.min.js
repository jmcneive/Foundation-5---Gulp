!function(t,i){var e=function(t,i,e){var s;return function(){function n(){e||t.apply(o,r),s=null}var o=this,r=arguments;s?clearTimeout(s):e&&t.apply(o,r),s=setTimeout(n,i||150)}};jQuery.fn[i]=function(t){return t?this.bind("resize",e(t)):this.trigger(i)}}(jQuery,"smartresize"),Object.keys||(Object.keys=function(t){var i,e=[];for(i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.push(i);return e}),function(t){t.Nested=function(i,e){this.element=t(e),this._init(i)},t.Nested.settings={selector:".box",minWidth:50,minColumns:1,gutter:1,centered:!1,resizeToFit:!0,resizeToFitOptions:{resizeAny:!0},animate:!0,animationOptions:{speed:20,duration:100,queue:!0,complete:function(){}}},t.Nested.prototype={_init:function(i){var e=this;this.box=this.element,t(this.box).css("position","relative"),this.options=t.extend(!0,{},t.Nested.settings,i),this.elements=[],this._isResizing=!1,this._update=!0,this.maxy=new Array,t(window).smartresize(function(){e.resize()}),this._setBoxes()},_setBoxes:function(i,e){var s=this;this.idCounter=0,this.counter=0,this.t=0,this.maxHeight=0,this.currWidth=0,this.total=this.box.find(this.options.selector),this.matrix={},this.gridrow=new Object;var n=this.options.centered?t(window).width():this.box.innerWidth();this.columns=Math.max(this.options.minColumns,parseInt(n/(this.options.minWidth+this.options.gutter))+1);var o=this.options.minWidth,r=this.options.gutter,h="block";i=this.box.find(this.options.selector),t.each(i,function(){var i=parseInt(t(this).attr("class").replace(/^.*size([0-9]+).*$/,"$1")).toString().split(""),n="N"==i[0]?1:parseFloat(i[0]),a="a"==i[1]?1:parseFloat(i[1]),d=o*n+r*(n-1),p=o*a+r*(a-1);t(this).css({display:h,position:"absolute",width:d,height:p,top:t(this).position().top,left:t(this).position().left}).removeClass("nested-moved").attr("data-box",s.idCounter).attr("data-width",d),s.idCounter++,s._renderGrid(t(this),e)}),s.counter==s.total.length&&(s.options.resizeToFit&&(s.elements=s._fillGaps()),s._renderItems(s.elements),s.elements=[])},_addMatrixRow:function(t){if(this.matrix[t])return!1;this.matrix[t]={};for(var i=0;i<this.columns-1;i++){var e=i*(this.options.minWidth+this.options.gutter);this.matrix[t][e]="false"}},_updateMatrix:function(t){for(var i=parseInt(t.y),e=parseInt(t.x),s=0;s<t.height;s+=this.options.minWidth+this.options.gutter)for(var n=0;n<t.width;n+=this.options.minWidth+this.options.gutter){var o=e+n,r=i+s;this.matrix[r]||this._addMatrixRow(r),this.matrix[r][o]="true"}},_getObjectSize:function(i){var e=0;return t.each(i,function(){e++}),e},_fillGaps:function(){var i=this,e={};t.each(this.elements,function(t,e){i._updateMatrix(e)});var s=this.elements;s.sort(function(t,i){return t.y-i.y}),s.reverse();var n=s[0].y,o=0,r=this._getObjectSize(this.matrix);return t.each(this.matrix,function(h,a){r--,o=parseInt(h),t.each(a,function(a,d){if("false"===d&&n>o){e.y||(e.y=h),e.x||(e.x=a),e.w||(e.w=0),e.h||(e.h=i.options.minWidth),e.w+=e.w?i.options.minWidth+i.options.gutter:i.options.minWidth;for(var p=0,u=1;r>u;u++){var c=parseInt(h)+parseInt(u*(i.options.minWidth+i.options.gutter));if(!i.matrix[c]||"false"!=i.matrix[c][a])break;p+=i.options.minWidth+i.options.gutter,i.matrix[c][a]="true"}e.h+(parseInt(p)/(i.options.minWidth+i.options.gutter)==r)?0:parseInt(p),e.ready=!0}else e.ready&&(t.each(s,function(n,o){return e.y<=s[n].y&&(i.options.resizeToFitOptions.resizeAny||e.w<=s[n].width&&e.h<=s[n].height)?(s.splice(n,1),t(o.$el).addClass("nested-moved"),i.elements.push({$el:t(o.$el),x:parseInt(e.x),y:parseInt(e.y),col:n,width:parseInt(e.w),height:parseInt(e.h)}),!1):void 0}),e={})})}),i.elements=s,i.elements},_renderGrid:function(t,i){this.counter++;var e,s=e=0,n=i?"prepend":"append",o=t.width(),r=t.height(),h=Math.ceil(o/(this.options.minWidth+this.options.gutter)),a=Math.ceil(r/(this.options.minWidth+this.options.gutter));for(h>this.options.minColumns&&(this.options.minColumns=h);;){for(var d=h;d>=0&&!this.gridrow[s+d];d--){this.gridrow[s+d]=new Object;for(var p=0;p<this.columns;p++)this.gridrow[s+d][p]=!1}for(var u=0;u<this.columns-h;u++){matrixY=s*(this.options.minWidth+this.options.gutter),this._addMatrixRow(matrixY);for(var c=!0,d=0;a>d;d++){for(var p=0;h>p&&this.gridrow[s+d];p++)if(this.gridrow[s+d][u+p]){c=!1;break}if(!c)break}if(c){for(var d=0;a>d;d++)for(var p=0;h>p&&this.gridrow[s+d];p++)this.gridrow[s+d][u+p]=!0;return void this._pushItem(t,u*(this.options.minWidth+this.options.gutter),s*(this.options.minWidth+this.options.gutter),o,r,h,a,n)}}s++}},_pushItem:function(t,i,e,s,n,o,r,h){"prepend"==h?this.elements.unshift({$el:t,x:i,y:e,width:s,height:n,cols:o,rows:r}):this.elements.push({$el:t,x:i,y:e,width:s,height:n,cols:o,rows:r})},_setHeight:function(i){var e=this;return t.each(i,function(t,i){var s=i.y+i.height;s>e.maxHeight&&(e.maxHeight=s)}),e.maxHeight},_setWidth:function(i){var e=this;return t.each(i,function(t,i){var s=i.x+i.width;s>e.currWidth&&(e.currWidth=s)}),e.currWidth},_renderItems:function(i){this.box.css("height",this._setHeight(i)),this.options.centered&&this.box.css({width:this._setWidth(i),"margin-left":"auto","margin-right":"auto"}),i.reverse();var e=this.options.animationOptions.speed,s=(this.options.animationOptions.effect,this.options.animationOptions.duration),n=this.options.animationOptions.queue,o=this.options.animate,r=this.options.animationOptions.complete,h=0,a=0;t.each(i,function(d,p){$currLeft=t(p.$el).position().left,$currTop=t(p.$el).position().top,$currWidth=t(p.$el).width(),$currHeight=t(p.$el).width(),p.$el.attr("data-y",$currTop).attr("data-x",$currLeft),o&&n&&($currLeft!=p.x||$currTop!=p.y)&&(setTimeout(function(){p.$el.css({display:"block",width:p.width,height:p.height}).animate({left:p.x,top:p.y},s),a++,a==h&&r.call(void 0,i)},h*e),h++),!o||n||$currLeft==p.x&&$currTop==p.y||(setTimeout(function(){p.$el.css({display:"block",width:p.width,height:p.height}).animate({left:p.x,top:p.y},s),a++,a==h&&r.call(void 0,i)},h),h++),o||$currLeft==p.x&&$currTop==p.y||(p.$el.css({display:"block",width:p.width,height:p.height,left:p.x,top:p.y}),a++,a==h&&r.call(void 0,i))}),0==h&&r.call(void 0,i)},append:function(t){this._isResizing=!0,this._setBoxes(t,"append"),this._isResizing=!1},prepend:function(t){this._isResizing=!0,this._setBoxes(t,"prepend"),this._isResizing=!1},resize:function(){Object.keys(this.matrix[0]).length%Math.floor(this.element.width()/(this.options.minWidth+this.options.gutter))>0&&(this._isResizing=!0,this._setBoxes(this.box.find(this.options.selector)),this._isResizing=!1)},refresh:function(i){i=i||this.options,this.options=t.extend(!0,{},t.Nested.settings,i),this.elements=[],this._isResizing=!1,this._setBoxes()},destroy:function(){var i=this;t(window).unbind("resize",function(){i.resize()}),$els=this.box.find(this.options.selector),t($els).removeClass("nested-moved").removeAttr("style data-box data-width data-x data-y").removeData(),this.box.removeAttr("style").removeData()}};var i={refresh:function(i){return this.each(function(){var e=t(this),s=e.data("nested");s.refresh(i)})},destroy:function(){return this.each(function(){var i=t(this),e=i.data("nested");e.destroy()})}};t.fn.nested=function(e,s){return i[e]?i[e].apply(this,Array.prototype.slice.call(arguments,1)):(this.each("string"==typeof e?function(){var i=t.data(this,"nested");i[e].apply(i,[s])}:function(){t.data(this,"nested",new t.Nested(e,this))}),this)}}(jQuery);